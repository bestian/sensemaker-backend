<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV 解析測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        input[type="file"] {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>CSV 解析測試</h1>
    
    <div class="test-section">
        <h3>測試 1: 簡單投票格式</h3>
        <p>測試簡單的 agrees/disagrees/passes 格式</p>
        <input type="file" id="simpleCsv" accept=".csv">
        <button onclick="testSimpleCsv()">測試簡單 CSV</button>
        <div id="simpleResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>測試 2: 分組投票格式</h3>
        <p>測試分組投票格式（如您的 comments.csv）</p>
        <input type="file" id="groupedCsv" accept=".csv">
        <button onclick="testGroupedCsv()">測試分組 CSV</button>
        <div id="groupedResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>測試 3: 直接測試 VoteTally</h3>
        <p>測試 VoteTally 類是否正常工作</p>
        <button onclick="testVoteTally()">測試 VoteTally</button>
        <div id="voteTallyResult" class="result"></div>
    </div>

    <script>
        // 模擬 VoteTally 類
        class VoteTally {
            constructor(agreeCount, disagreeCount, passCount = 0) {
                this.agreeCount = agreeCount;
                this.disagreeCount = disagreeCount;
                this.passCount = passCount;
            }

            getTotalCount(includePasses) {
                if (includePasses) {
                    return this.agreeCount + this.disagreeCount + this.passCount;
                } else {
                    return this.agreeCount + this.disagreeCount;
                }
            }
        }

        // 模擬 CSV 解析函數
        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const lines = csvText.trim().split('\n');
                        
                        if (lines.length < 2) {
                            throw new Error('CSV file must have at least a header row and one data row');
                        }

                        const headers = lines[0].split(',').map(h => h.trim());
                        const dataLines = lines.slice(1);

                        console.log('CSV Headers:', headers);
                        console.log('Data lines count:', dataLines.length);

                        // 查找必要的列
                        const idIndex = headers.findIndex(h => h === 'comment-id' || h === 'id');
                        const textIndex = headers.findIndex(h => h === 'comment_text' || h === 'text');
                        
                        if (idIndex === -1 || textIndex === -1) {
                            throw new Error('CSV must contain comment-id (or id) and comment_text (or text) columns');
                        }

                        // 查找投票相關列
                        const voteColumns = headers.filter(h => 
                            h.includes('-agree-count') || 
                            h.includes('-disagree-count') || 
                            h.includes('-pass-count') ||
                            h === 'agrees' || 
                            h === 'disagrees' || 
                            h === 'passes'
                        );

                        console.log('Vote columns found:', voteColumns);

                        // 檢查是否有群組信息
                        const hasGroupInfo = voteColumns.some(col => col.includes('-agree-count'));
                        const groupNames = [];
                        
                        if (hasGroupInfo) {
                            // 提取群組名稱
                            groupNames.push(...new Set(voteColumns.map(col => col.split('-')[0])));
                            console.log('Group names:', groupNames);
                        }

                        const comments = [];

                        for (let i = 0; i < dataLines.length; i++) {
                            const line = dataLines[i];
                            const values = line.split(',').map(v => v.trim());
                            
                            console.log(`Processing line ${i + 1}:`, values);
                            
                            const comment = {
                                id: values[idIndex] || `comment-${i}`,
                                text: values[textIndex] || ''
                            };

                            // 處理投票信息
                            if (voteColumns.length > 0) {
                                try {
                                    if (hasGroupInfo) {
                                        // 群組投票格式
                                        const voteInfo = {};
                                        groupNames.forEach(group => {
                                            const agreeCol = headers.findIndex(h => h === `${group}-agree-count`);
                                            const disagreeCol = headers.findIndex(h => h === `${group}-disagree-count`);
                                            const passCol = headers.findIndex(h => h === `${group}-pass-count`);
                                            
                                            if (agreeCol !== -1 && disagreeCol !== -1) {
                                                const agreeCount = parseInt(values[agreeCol]) || 0;
                                                const disagreeCount = parseInt(values[disagreeCol]) || 0;
                                                const passCount = passCol !== -1 ? (parseInt(values[passCol]) || 0) : 0;
                                                
                                                console.log(`Creating VoteTally for group ${group}:`, { agreeCount, disagreeCount, passCount });
                                                
                                                try {
                                                    voteInfo[group] = new VoteTally(agreeCount, disagreeCount, passCount);
                                                    console.log(`VoteTally created successfully for group ${group}:`, voteInfo[group]);
                                                } catch (error) {
                                                    console.error(`Error creating VoteTally for group ${group}:`, error);
                                                    // 如果 VoteTally 創建失敗，使用普通對象
                                                    voteInfo[group] = {
                                                        agreeCount,
                                                        disagreeCount,
                                                        passCount,
                                                        getTotalCount: (includePasses) => {
                                                            if (includePasses) {
                                                                return agreeCount + disagreeCount + passCount;
                                                            } else {
                                                                return agreeCount + disagreeCount;
                                                            }
                                                        }
                                                    };
                                                }
                                            }
                                        });
                                        
                                        if (Object.keys(voteInfo).length > 0) {
                                            comment.voteInfo = voteInfo;
                                        }
                                    } else {
                                        // 簡單投票格式
                                        const agreesIndex = headers.findIndex(h => h === 'agrees');
                                        const disagreesIndex = headers.findIndex(h => h === 'disagrees');
                                        const passesIndex = headers.findIndex(h => h === 'passes');
                                        
                                        if (agreesIndex !== -1 && disagreesIndex !== -1) {
                                            const agrees = parseInt(values[agreesIndex]) || 0;
                                            const disagrees = parseInt(values[disagreesIndex]) || 0;
                                            const passes = passesIndex !== -1 ? (parseInt(values[passesIndex]) || 0) : 0;
                                            
                                            console.log('Creating simple VoteTally:', { agrees, disagrees, passes });
                                            
                                            try {
                                                comment.voteInfo = new VoteTally(agrees, disagrees, passes);
                                                console.log('Simple VoteTally created successfully:', comment.voteInfo);
                                            } catch (error) {
                                                console.error('Error creating simple VoteTally:', error);
                                                // 如果 VoteTally 創建失敗，使用普通對象
                                                comment.voteInfo = {
                                                    agreeCount: agrees,
                                                    disagreeCount: disagrees,
                                                    passCount: passes,
                                                    getTotalCount: (includePasses) => {
                                                        if (includePasses) {
                                                            return agrees + disagrees + passes;
                                                        } else {
                                                            return agrees + disagrees;
                                                        }
                                                    }
                                                };
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error processing vote information:', error);
                                }
                            }

                            comments.push(comment);
                            console.log(`Comment ${i + 1} created:`, comment);
                        }

                        console.log('Total comments created:', comments.length);
                        resolve(comments);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function testSimpleCsv() {
            const fileInput = document.getElementById('simpleCsv');
            const resultDiv = document.getElementById('simpleResult');
            
            if (!fileInput.files[0]) {
                resultDiv.textContent = '請選擇一個 CSV 文件';
                resultDiv.className = 'result error';
                return;
            }

            try {
                const comments = await parseCSVFile(fileInput.files[0]);
                resultDiv.textContent = `解析成功！共解析 ${comments.length} 條評論\n\n${JSON.stringify(comments, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `解析失敗：${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testGroupedCsv() {
            const fileInput = document.getElementById('groupedCsv');
            const resultDiv = document.getElementById('groupedResult');
            
            if (!fileInput.files[0]) {
                resultDiv.textContent = '請選擇一個 CSV 文件';
                resultDiv.className = 'result error';
                return;
            }

            try {
                const comments = await parseCSVFile(fileInput.files[0]);
                resultDiv.textContent = `解析成功！共解析 ${comments.length} 條評論\n\n${JSON.stringify(comments, null, 2)}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `解析失敗：${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        function testVoteTally() {
            const resultDiv = document.getElementById('voteTallyResult');
            
            try {
                const voteTally = new VoteTally(5, 3, 2);
                const totalWithPasses = voteTally.getTotalCount(true);
                const totalWithoutPasses = voteTally.getTotalCount(false);
                
                resultDiv.textContent = `VoteTally 測試成功！\n\n實例：${JSON.stringify(voteTally, null, 2)}\n\n總票數（包含 passes）：${totalWithPasses}\n總票數（不包含 passes）：${totalWithoutPasses}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `VoteTally 測試失敗：${error.message}`;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>
